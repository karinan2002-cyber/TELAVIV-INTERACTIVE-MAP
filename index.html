<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// כתובת ה-URL של הסקר (הקישור לגוגל שיטס)
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyom4ORO0eatLuYOOL8U0H89aUWAp0iWlwVqoSZ2NTrRtWgPycwGJOQwIiz3SKC-mFQ/exec";

// יצירת המפה
const map = L.map("map").setView([32.125,34.802],16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// רשימת איכויות לכל פארק
const qualities = ["נוף יפה","מרחב טבע","הרגשה של יער","חופש ומרחב","פארק אטרקטיבי","שקט ושלווה","אזור עם מתקנים לפעילויות","היסטוריה ותרבות","אתר טבע חשוב","לא נעים","מפחיד","רועש","איכות אחרת – כתבו כאן:"];

// נתוני הפארקים (כולל שמות, קואורדינטות ותמונות)
const parksData = [
  {"name":"גן רוזין","lat":32.126187,"lon":34.803838, "image":"images/rosin.jpg"},
  {"name":"גן אלפרד ביר","lat":32.126725,"lon":34.799704, "image":"images/alfred.jpg"},
  {"name":"מרכז קהילתי רוזין","lat":32.126956,"lon":34.804118, "image":"images/community.jpg"}
  // הוסף כאן את יתר הפארקים עם שמותיהם, קואורדינטותיהם והתמונות
];

let nickname = "";

// התייחסות לחלונית הכינוי
const nicknamePopup = document.getElementById("nickname-popup");
const nicknameInput = document.getElementById("nickname-input");
const nicknameSubmit = document.getElementById("nickname-submit");

// הוספת כינוי אישי
nicknameSubmit.onclick = () => {
  if(nicknameInput.value.trim()==="") { alert("אנא הכניסו כינוי!"); return; }
  nickname = nicknameInput.value.trim();
  nicknamePopup.classList.remove("show");
  alert("תודה! עכשיו אפשר להתחיל במפה.");
};

// שליחה לגוגל שיטס
function sendDataToSheet(parkName, quality, value){
  fetch(SCRIPT_URL,{
    method:"POST",
    body: JSON.stringify({parkName, quality, value, nickname, timestamp:new Date().toISOString()}),
    headers: {"Content-Type":"application/json"}
  })
  .then(res=>res.json())
  .then(d=>console.log("נשלח:",d))
  .catch(e=>console.error("שגיאה בשמירה:", e));
}

// יצירת סמל לפארק על המפה
function createIcon(active=false){
  const borderColor = active ? "#00C853":"white";
  const background = active ? "#C8E6C9":"#4CAF50";
  return L.divIcon({className:"", html:`<div style="width:32px;height:32px;border-radius:50%;border:2px solid ${borderColor};background:${background};"></div>`});
}

let selectedParks = 0;
const finishBtn = document.getElementById("finish-btn");

// הוספת כל הפארקים על המפה
parksData.forEach(p=>{
  p.hasSelection=false;
  const marker = L.marker([p.lat,p.lon],{icon:createIcon(false)}).addTo(map);

  marker.on("click",()=>{
    const popup=document.getElementById("popup");
    const title=document.getElementById("popup-title");
    const checkboxesDiv=document.getElementById("checkboxes");
    const additionalQ=document.getElementById("additional-question");
    const yesBtn=document.getElementById("yes-btn");
    const noBtn=document.getElementById("no-btn");
    const saveMsg=document.getElementById("save-msg");

    title.textContent=p.name;
    checkboxesDiv.innerHTML="";
    additionalQ.style.display="none";
    saveMsg.style.display="none";

    checkboxesDiv.innerHTML+=`<img src="${p.image}" alt="${p.name}" style="width:100%;border-radius:10px;margin-bottom:10px;">`;

    qualities.forEach(q=>{
      if(q.includes("איכות אחרת")){
        checkboxesDiv.innerHTML+=`<label><input type="checkbox" value="${q}" class="chk"> ${q}</label><textarea class="other-text" placeholder="כתבו כאן..." rows="2"></textarea>`;
      } else {
        checkboxesDiv.innerHTML+=`<label><input type="checkbox" value="${q}" class="chk"> ${q}</label>`;
      }
    });

    popup.classList.add("show");

    const checkboxes = checkboxesDiv.querySelectorAll("input[type='checkbox']");
    const otherField = checkboxesDiv.querySelector(".other-text");

    checkboxes.forEach(chk=>{
      chk.onchange=()=>{
        const anyChecked=[...checkboxes].some(c=>c.checked);
        if
        if(!p.hasSelection && anyChecked) selectedParks++;
        p.hasSelection=anyChecked;

        marker.setIcon(createIcon(anyChecked));

        sendDataToSheet(p.name, chk.value, chk.checked);

        if(anyChecked) {
          saveMsg.style.display = "block";
        }

        if(selectedParks > 0) {
          finishBtn.classList.add("ready");
          finishBtn.style.cursor = "pointer";
        } else {
          finishBtn.classList.remove("ready");
          finishBtn.style.cursor = "not-allowed";
        }
      };
    });

    yesBtn.onclick = () => {
      additionalQ.style.display = "none";
      sendDataToSheet(p.name, "איכות אחרת", otherField.value);
    };

    noBtn.onclick = () => {
      additionalQ.style.display = "none";
    };
  });
});

// סיום השאלון
finishBtn.onclick = () => {
  if(finishBtn.classList.contains("ready")) {
    alert("תודה על השתתפותך בשאלון!");
  }
};

</script>
</body>
</html>
