<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="utf-8" />
<title>××¤×ª ×’×™× ×•×ª â€“ ×©××œ×•×Ÿ ××™×›×•×™×•×ª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; padding:0; direction:rtl; font-family:sans-serif; overflow:hidden; }
#map { position:absolute; top:0; bottom:0; width:100%; }

.popup-container {
  position: fixed; top:50%; left:50%;
  transform: translate(-50%, -50%) scale(0.8);
  background: #ffffff;
  padding:16px 20px;
  border-radius:16px;
  width:90%; max-width:360px;
  z-index:9999;
  text-align:right;
  color:#000;
  box-shadow:0 8px 20px rgba(0,0,0,0.4);
  display:none;
  opacity:0;
  transition:all 0.3s ease-in-out;
}
.popup-container.show { display:block; opacity:1; transform:translate(-50%, -50%) scale(1); }

.popup-container h4 { margin:6px 0; font-size:1.1em; }
.popup-container p.question { font-weight:bold; margin-bottom:8px; font-size:1em; }
.popup-container textarea { width:90%; border-radius:4px; padding:4px; margin-top:4px; font-family:inherit; display:block; }
.popup-container label { display:block; margin:4px 0; font-size:0.95em; }
.popup-container button { background-color:#388E3C; color:white; border:none; border-radius:8px; padding:8px 16px; margin:6px; cursor:pointer; font-weight:bold; transition:all 0.2s; }
.popup-container button:hover { background-color:#2e7d32; }
.save-msg { display:none; font-weight:bold; margin-top:8px; color:#388E3C; }

#finish-btn { position:fixed; bottom:10px; left:10px; background:#ccc; color:white; border:none; border-radius:8px; padding:10px 20px; cursor:not-allowed; font-weight:bold; z-index:9999; transition:all 0.3s ease; }
#finish-btn.ready { background:#388E3C; cursor:pointer; }
</style>
</head>
<body>

<div id="map"></div>

<!-- ×—×œ×•× ×™×ª ×©××œ×•×Ÿ ×¤×ª×™×—×” ×œ×›×™× ×•×™ -->
<div id="nickname-popup" class="popup-container show">
  <p>ğŸ˜Š ×× × ×”×›× ×™×¡×• ×›×™× ×•×™ ××™×©×™:</p>
  <input type="text" id="nickname-input" placeholder="×œ××©×œ: ×¤×™×œ×¤×™×œ×•×Ÿ">
  <button id="nickname-submit">×©×œ×—</button>
</div>

<!-- ×—×œ×•× ×™×ª ×©××œ×•×Ÿ ×œ×›×œ ×¤××¨×§ -->
<div id="popup" class="popup-container">
  <p class="question">××™×œ×• ××™×›×•×™×•×ª ×™×© ×œ××¨×—×‘?</p>
  <h4 id="popup-title"></h4>
  <div id="checkboxes"></div>
  <div id="additional-question">
    <p><strong>×”×× ×™×© ×œ××§×•× ××™×›×•×™×•×ª × ×•×¡×¤×•×ª?</strong></p>
    <button id="yes-btn">×›×Ÿ</button>
    <button id="no-btn">×œ×</button>
  </div>
  <div id="save-msg" class="save-msg">âœ” × ×©××¨!</div>
</div>

<button id="finish-btn">×¡×™×•× ×©××œ×•×Ÿ</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyom4ORO0eatLuYOOL8U0H89aUWAp0iWlwVqoSZ2NTrRtWgPycwGJOQwIiz3SKC-mFQ/exec";

const map = L.map("map").setView([32.125,34.802],16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const qualities = ["× ×•×£ ×™×¤×”","××¨×—×‘ ×˜×‘×¢","×”×¨×’×©×” ×©×œ ×™×¢×¨","×—×•×¤×© ×•××¨×—×‘","×¤××¨×§ ××˜×¨×§×˜×™×‘×™","×©×§×˜ ×•×©×œ×•×•×”","××–×•×¨ ×¢× ××ª×§× ×™× ×œ×¤×¢×™×œ×•×™×•×ª","×”×™×¡×˜×•×¨×™×” ×•×ª×¨×‘×•×ª","××ª×¨ ×˜×‘×¢ ×—×©×•×‘","×œ× × ×¢×™×","××¤×—×™×“","×¨×•×¢×©","××™×›×•×ª ××—×¨×ª â€“ ×›×ª×‘×• ×›××Ÿ:"];

const parksData = [
  {"name":"×’×Ÿ ×¨×•×–×™×Ÿ","lat":32.126187,"lon":34.803838, "image":"images/rosin.jpg"},
  {"name":"×’×Ÿ ××œ×¤×¨×“ ×‘×™×¨","lat":32.126725,"lon":34.799704, "image":"images/alfred.jpg"},
  {"name":"××¨×›×– ×§×”×™×œ×ª×™ ×¨×•×–×™×Ÿ","lat":32.126956,"lon":34.804118, "image":"images/community.jpg"}
  // ×›××Ÿ ×ª×•×›×œ ×œ×”×•×¡×™×£ ××ª ×›×œ ×”×¤××¨×§×™× ×©×œ×š ×›×•×œ×œ × ×ª×™×‘ ×”×ª××•× ×” ×¢×‘×•×¨ ×›×œ ××—×“
];

let nickname = "";
const nicknamePopup = document.getElementById("nickname-popup");
const nicknameInput = document.getElementById("nickname-input");
const nicknameSubmit = document.getElementById("nickname-submit");

nicknameSubmit.onclick = () => {
  if(nicknameInput.value.trim()==="") { alert("×× × ×”×›× ×™×¡×• ×›×™× ×•×™!"); return; }
  nickname = nicknameInput.value.trim();
  nicknamePopup.classList.remove("show");
  alert("×ª×•×“×”! ×¢×›×©×™×• ××¤×©×¨ ×œ×”×ª×—×™×œ ×‘××¤×”.");
};

// ×¤×•× ×§×¦×™×” ×œ×©×œ×™×—×ª ×”× ×ª×•× ×™× ×œ×’×•×’×œ ×©×™×˜×¡
function sendDataToSheet(parkName, quality, value){
  fetch(SCRIPT_URL,{
    method:"POST",
    body: JSON.stringify({parkName, quality, value, nickname, timestamp:new Date().toISOString()}),
    headers: {"Content-Type":"application/json"}
  })
  .then(res=>res.json())
  .then(d=>console.log("× ×©×œ×—:",d))
  .catch(e=>console.error("×©×’×™××” ×‘×©××™×¨×”:", e));
}

function createIcon(active=false){
  const borderColor = active ? "#00C853":"white";
  const background = active ? "#C8E6C9":"#4CAF50";
  return L.divIcon({className:"", html:`<div style="width:32px;height:32px;border-radius:50%;border:2px solid ${borderColor};background:${background};"></div>`});
}

let selectedParks = 0;
const finishBtn = document.getElementById("finish-btn");

parksData.forEach(p=>{
  p.hasSelection=false;
  const marker = L.marker([p.lat,p.lon],{icon:createIcon(false)}).addTo(map);

  marker.on("click",()=>{
    const popup=document.getElementById("popup");
    const title=document.getElementById("popup-title");
    const checkboxesDiv=document.getElementById("checkboxes");
    const additionalQ=document.getElementById("additional-question");
    const yesBtn=document.getElementById("yes-btn");
    const noBtn=document.getElementById("no-btn");
    const saveMsg=document.getElementById("save-msg");

    title.textContent=p.name;
    checkboxesDiv.innerHTML="";
    additionalQ.style.display="none";
    saveMsg.style.display="none";

    checkboxesDiv.innerHTML+=`<img src="${p.image}" alt="${p.name}" style="width:100%;border-radius:10px;margin-bottom:10px;">`;

    qualities.forEach(q=>{
      if(q.includes("××™×›×•×ª ××—×¨×ª")){
        checkboxesDiv.innerHTML+=`<label><input type="checkbox" value="${q}" class="chk"> ${q}</label><textarea class="other-text" placeholder="×›×ª×‘×• ×›××Ÿ..." rows="2"></textarea>`;
      } else {
        checkboxesDiv.innerHTML+=`<label><input type="checkbox" value="${q}" class="chk"> ${q}</label>`;
      }
    });

    popup.classList.add("show");

    const checkboxes = checkboxesDiv.querySelectorAll("input[type='checkbox']");
    const otherField = checkboxesDiv.querySelector(".other-text");
    let typingTimer;

    checkboxes.forEach(chk=>{
      chk.onchange=()=>{
        const anyChecked=[...checkboxes].some(c=>c.checked);
        if(!p.hasSelection && anyChecked) selectedParks++;
        p.hasSelection=anyChecked;

        marker.setIcon(createIcon(anyChecked));

        sendDataToSheet(p.name, chk.value, chk.checked);

        if(anyChecked){
          saveMsg.style.display="block";
          setTimeout(()=>popup.classList.remove("show"),1500);
        }

        if(selectedParks>=1) finishBtn.classList.add("ready");
      };
    });

    if
