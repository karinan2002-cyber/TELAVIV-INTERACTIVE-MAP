<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="utf-8" />
<title>××¤×ª ×’×™× ×•×ª ×•×‘×ª×™ ×§×¤×” â€“ ×©××œ×•×Ÿ ××™×›×•×™×•×ª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; padding:0; direction:rtl; font-family:sans-serif; overflow:hidden; }
#map { position:absolute; top:0; bottom:0; width:100%; }
.popup-container { position: fixed; top:50%; left:50%; transform: translate(-50%, -50%) scale(0.8); background: #fff; padding:16px 20px; border-radius:16px; width:90%; max-width:360px; z-index:9999; text-align:right; color:#000; box-shadow:0 8px 20px rgba(0,0,0,0.4); display:none; opacity:0; transition:all 0.3s ease-in-out; }
.popup-container.show { display:block; opacity:1; transform:translate(-50%, -50%) scale(1); }
.popup-container h4 { margin:6px 0; font-size:1.1em; }
.popup-container p.question { font-weight:bold; margin-bottom:8px; font-size:1em; }
.popup-container img { width:120px; height:120px; border-radius:50%; object-fit:contain !important; background-color:#fff; border:2px solid #ddd; margin:8px auto; display:block; transform: scale(1.2); }
.popup-container label { display:block; margin:4px 0; font-size:0.95em; }
.popup-container textarea { width:90%; border-radius:4px; padding:4px; margin-top:4px; font-family:inherit; display:block; transform: scale(1.2); }
.popup-container button { background-color:#388E3C; color:white; border:none; border-radius:8px; padding:8px 16px; margin:6px; cursor:pointer; font-weight:bold; transition:all 0.2s; }
.popup-container button:hover { background-color:#2e7d32; }
.save-msg { display:none; font-weight:bold; margin-top:8px; color:#388E3C; }

#nickname-popup input { width:90%; padding:6px; border-radius:6px; margin-top:6px; font-size:1em; font-family:inherit; }
#nickname-popup p { font-size:1em; margin-bottom:6px; }

#additional-question { opacity:0; transform:translateY(10px); transition:all 0.35s ease; }
#additional-question.show { opacity:1; transform:translateY(0); }

.marker-thumb { width:52px; height:52px; border-radius:50%; border:2px solid white; overflow:hidden; box-shadow:0 0 4px rgba(0,0,0,0.4); background-color:#4CAF50; position:relative; }
.marker-thumb img { width:100%; height:100%; object-fit:cover !important; }

.confirm-icon { position:absolute; top:40%; left:50%; transform:translate(-50%, -50%) scale(0.8); background-color:#00C853; color:white; font-weight:bold; border-radius:50%; width:72px; height:72px; text-align:center; line-height:72px; font-size:48px; opacity:0; transition:all 0.4s ease; pointer-events:none; z-index:1000; }
.confirm-icon.show { opacity:1; transform:translate(-50%, -50%) scale(1.2); }

#main-question { position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#fff; padding:12px 16px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3); max-width:360px; z-index:9999; text-align:center; font-size:0.95em; color:#000; transition:all 0.3s ease; }
#main-question.hide { opacity:1; transform:translate(-50%, 0); pointer-events:auto; }

#finish-btn { position:fixed; bottom:10px; left:10px; background:#ccc; color:white; border:none; border-radius:8px; padding:10px 20px; cursor:not-allowed; font-weight:bold; z-index:9999; transition:all 0.3s ease; }
#finish-btn.ready { background:#388E3C; cursor:pointer; }
</style>
</head>
<body>

<div id="map"></div>

<div id="main-question">
  <strong>××™×œ×• ××™×›×•×™×•×ª ×™×© ×œ××¨×—×‘×™× ×”×¦×™×‘×•×¨×™×™× ×”×™×¨×•×§×™× ×‘×¡×‘×™×‘×ª ×”××’×•×¨×™× ×©×œ×›×?</strong><br>
  ×× × ×œ×—×¦×• ×¢×œ ×ª××•× ×” ×•×¢× ×• ×¢×œ ×”×©××œ×”.
</div>

<div id="nickname-popup" class="popup-container">
  <p>ğŸ˜Š ×× × ×”×›× ×™×¡×• ×›×™× ×•×™ ××™×©×™ (×œ×–×›×¨/× ×§×‘×”):</p>
  <input type="text" id="nickname-input" placeholder="×œ××©×œ: ×¤×™×œ×¤×™×œ×•×Ÿ">
  <button id="nickname-submit">×©×œ×—</button>
</div>

<div id="popup" class="popup-container">
  <p class="question">××™×œ×• ××™×›×•×™×•×ª ×™×© ×œ××¨×—×‘?</p>
  <h4 id="popup-title"></h4>
  <img id="popup-img" src="">
  <div id="checkboxes"></div>
  <div id="additional-question">
    <p><strong>×”×× ×™×© ×œ××§×•× ××™×›×•×™×•×ª × ×•×¡×¤×•×ª?</strong></p>
    <button id="yes-btn">×›×Ÿ</button>
    <button id="no-btn">×œ×</button>
  </div>
  <div id="save-msg" class="save-msg">âœ” × ×©××¨!</div>
</div>

<div id="check-icon" class="confirm-icon">âœ”</div>
<button id="finish-btn">×¡×™×•× ×©××œ×•×Ÿ</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxTvR67LI7UghEJ7INhorA38U6PLsH9izZLEcSgdUZz-0TZ2aAmYqR6ReXJhSR-yhy0/exec"; // ×›××Ÿ ×œ×”×›× ×™×¡ ××ª URL ×©×œ ×”-Apps Script ×©×œ×š

const map = L.map("map").setView([32.125, 34.802], 16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const qualities = [
  "× ×•×£ ×™×¤×”","××¨×—×‘ ×˜×‘×¢","×”×¨×’×©×” ×©×œ ×™×¢×¨","×—×•×¤×© ×•××¨×—×‘","×¤××¨×§ ××˜×¨×§×˜×™×‘×™",
  "×©×§×˜ ×•×©×œ×•×•×”","××–×•×¨ ×¢× ××ª×§× ×™× ×œ×¤×¢×™×œ×•×™×•×ª","×”×™×¡×˜×•×¨×™×” ×•×ª×¨×‘×•×ª","××ª×¨ ×˜×‘×¢ ×—×©×•×‘",
  "×œ× × ×¢×™×","××¤×—×™×“","×¨×•×¢×©","××™×›×•×ª ××—×¨×ª â€“ ×›×ª×‘×• ×›××Ÿ:"
];

const excluded = ["××§×•×¤××¨×§ ×’×œ×™×œ×•×ª","×’×™× ×ª ××œ×‘×•×™× ×¨×•×Ÿ","×’×Ÿ ×¨×•×•×–×× ×™×¡","×’×™× ×ª ×§×¨×™×¡×¤×™×Ÿ ×—×™×™×","×’×™× ×ª ×¨×•×× ×•","×’×™× ×ª ×¨×™×–×¤×œ×“","××—× ×” ×“×•×œ×¤×™×Ÿ","×—×•×œ×•×ª","×‘×™×ª ×”×œ×•×—×"];

const parksData = [
  {"name":"×’×Ÿ ×¨×•×–×™×Ÿ","lat":32.126187,"lon":34.803838},
  {"name":"×’×Ÿ ××œ×¤×¨×“ ×‘×™×¨","lat":32.126725,"lon":34.799704},
  {"name":"××¨×›×– ×§×”×™×œ×ª×™ ×¨×•×–×™×Ÿ","lat":32.126956,"lon":34.804118},
  {"name":"××¨×›×– ××œ×¨×-×©×•×¡×˜×¨","lat":32.125162,"lon":34.803658},
  {"name":"×§×× ×˜×¨×™ ×’×™××œ","lat":32.127565,"lon":34.803042},
  {"name":"×’×Ÿ ×”×¤×¡×œ","lat":32.126009,"lon":34.797823},
  {"name":"×’×Ÿ ×¤×™×™× ×©×˜×™×™×Ÿ","lat":32.127806,"lon":34.798541},
  {"name":"×’×Ÿ ××œ×§×™× ×“","lat":32.128201,"lon":34.796766},
  {"name":"×§×× ×˜×¨×™ ×‘×¨×–× ×™","lat":32.127002,"lon":34.796730},
  {"name":"×—×•×¨×©×ª ×“×¨×–× ×¨","lat":32.128074,"lon":34.806370},
  {"name":"×’×Ÿ ×™×”×•×“×” ×œ×™×©","lat":32.125499,"lon":34.805951},
  {"name":"×’×Ÿ ×›×¦× ×œ×¡×•×Ÿ","lat":32.123660,"lon":34.799530},
  {"name":"×’×Ÿ ×‘×•×™××¨","lat":32.123350,"lon":34.795436},
  {"name":"×’×Ÿ ×”××™×™×¡×“×™×","lat":32.129443,"lon":34.791957},
  {"name":"×’×Ÿ ××‘×™×’×•×¨-××–×•×¨×™ ×—×Ÿ","lat":32.129959,"lon":34.794299},
  {"name":"×’×™× ×ª ×‘×•×¡×ª×Ÿ ×”××™× ×™×","lat":32.129725,"lon":34.792718},
  {"name":"×’×™× ×ª ××•×§×“×™","lat":32.128172,"lon":34.793628},
  {"name":"×’×Ÿ ×©× ×™×¦×¨","lat":32.126109,"lon":34.793089},
  {"name":"××’×¨×© ×¡××‘×•×¨×¡×§×™","lat":32.126767,"lon":34.793759},
  {"name":"×’×™× ×ª ×‘×¨×œ×™×Ÿ","lat":32.124129,"lon":34.792870},
  {"name":"×§×× ×˜×¨×™ ××–×•×¨×™ ×—×Ÿ","lat":32.130632,"lon":34.792803},
  {"name":"×’×™× ×ª ××œ×›×¡× ×“×¨ ×¤×Ÿ","lat":32.123369,"lon":34.811476},
  {"name":"×’×™× ×ª ××™×§×“×•","lat":32.122888,"lon":34.815628},
  {"name":"×’×Ÿ ×©×•×¨×¨ ×—×™×™×","lat":32.122829,"lon":34.811449},
  {"name":"×’×Ÿ ×‘×™×ª ×¦×•×¨×™","lat":32.12311275936392,"lon":34.801534712924436},
  {"name":"×’×Ÿ ×œ×™××•×Ÿ ×¨×§× ××˜×™","lat":32.12273266261491,"lon":34.803450038810816},
  {"name":"×’×™× ×ª ×‘×¨×§××™","lat":32.1240135,"lon":34.8064948},
  {"name":"×’×™× ×ª ×”×¨×•×—×•×ª","lat":32.12349022117299,"lon":34.816722543405106}
].filter(p => !excluded.includes(p.name));

let nickname = "";
const nicknamePopup = document.getElementById("nickname-popup");
const nicknameInput = document.getElementById("nickname-input");
const nicknameSubmit = document.getElementById("nickname-submit");

nicknamePopup.classList.add("show");

nicknameSubmit.onclick = () => {
  if(nicknameInput.value.trim()==="") { alert("×× × ×”×›× ×™×¡×• ×›×™× ×•×™!"); return; }
  nickname = nicknameInput.value.trim();
  localStorage.setItem("nickname", nickname);
  
  // ×©×œ×™×—×” ×¨××©×•× ×™×ª ×©×œ ×›×™× ×•×™ + ×ª××¨×™×š
  const formData = new FormData();
  formData.append("nickname", nickname);
  formData.append("timestamp", new Date().toISOString());

  fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", body:formData });

  nicknamePopup.classList.remove("show");
  alert("×ª×•×“×”! ×¢×›×©×™×• ××¤×©×¨ ×œ×”×ª×—×™×œ ×‘××¤×” ğŸ˜Š");
};

const userId = localStorage.getItem("userId") || Math.random().toString(36).substr(2,9);
localStorage.setItem("userId", userId);

function sendDataToSheet(parkName, quality, value){
  const userId = localStorage.getItem("userId") || Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
  const nickname = localStorage.getItem("nickname") || "";

  const formData = new FormData();
  formData.append("parkName", parkName);
  formData.append("quality", quality);
  formData.append("value", value);
  formData.append("userId", userId);
  formData.append("nickname", nickname);
  formData.append("timestamp", new Date().toISOString());

  fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", body:formData });
}

function createIcon(name, active=false){
  const borderColor = active ? "#00C853":"white";
  const background = active ? "#C8E6C9":"#4CAF50";
  return L.divIcon({
    className:"",
    html:`<div class="marker-thumb" style="border-color:${borderColor};background:${background};">
            <img src="images/${name}.jpg" onerror="this.style.display='none';this.parentElement.style.backgroundColor='#228B22';">
          </div>`
  });
}

let selectedParks = 0;
const mainQuestion = document.getElementById("main-question");
const finishBtn = document.getElementById("finish-btn");

parksData.forEach(p=>{
  p.hasSelection=false;
  const marker = L.marker([p.lat,p.lon], {icon:createIcon(p.name,false)}).addTo(map);

  marker.on("click",()=>{
    const popup=document.getElementById("popup");
    const title=document.getElementById("popup-title");
    const img=document.getElementById("popup-img");
    const checkboxesDiv=document.getElementById("checkboxes");
    const additionalQ=document.getElementById("additional-question");
    const yesBtn=document.getElementById("yes-btn");
    const noBtn=document.getElementById("no-btn");
    const saveMsg=document.getElementById("save-msg");
    const checkIcon=document.getElementById("check-icon");

    title.textContent=p.name;
    img.src=`images/${p.name}.jpg`;

    checkboxesDiv.innerHTML="";
    additionalQ.classList.remove("show");
    saveMsg.style.display="none";

    qualities.forEach(q=>{
      if(q.includes("××™×›×•×ª ××—×¨×ª")){
        checkboxesDiv.innerHTML+=
          `<label><input type="checkbox" value="${q}" class="chk"> ${q}</label>
           <textarea class="other-text" placeholder="×›×ª×‘×• ×›××Ÿ..." rows="2"></textarea>`;
      } else {
        checkboxesDiv.innerHTML+=
          `<label><input type="checkbox" value="${q}" class="chk"> ${q}</label>`;
      }
    });

    popup.classList.add("show");

    const checkboxes = checkboxesDiv.querySelectorAll("input[type='checkbox']");
    const otherField = checkboxesDiv.querySelector(".other-text");
    let typingTimer;

    checkboxes.forEach(chk=>{
      chk.onchange=()=>{
        const anyChecked=[...checkboxes].some(c=>c.checked);
        if(!p.hasSelection && anyChecked) selectedParks++;
        p.hasSelection=anyChecked;

        marker.setIcon(createIcon(p.name, anyChecked));
        sendDataToSheet(p.name, chk.value, chk.checked);

        if(anyChecked){
          checkIcon.classList.add("show");
          setTimeout(()=>{ checkIcon.classList.remove("show"); additionalQ.classList.add("show"); },800);
        }

        if(selectedParks>=5) finishBtn.classList.add("ready");
      };
    });

    if(otherField){
      otherField.addEventListener("input", ()=>{
        clearTimeout(typingTimer);
        typingTimer = setTimeout(()=>{ sendDataToSheet(p.name,"××™×›×•×ª ××—×¨×ª (×˜×§×¡×˜ ×—×•×¤×©×™)",otherField.value); },1200);
      });
    }

    yesBtn.onclick=()=>additionalQ.classList.remove("show");
    noBtn.onclick=()=>{
      additionalQ.classList.remove("show");
      saveMsg.style.display="block";
      setTimeout(()=>popup.classList.remove("show"),1500);
    };

  });
});

finishBtn.onclick=()=>{ if(selectedParks>=5) alert("×ª×•×“×” ×©×¡×™×™××ª× ××ª ×”×©××œ×•×Ÿ!"); };
</script>
</body>
</html>

