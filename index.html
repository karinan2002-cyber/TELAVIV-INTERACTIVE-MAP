<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="utf-8" />
<title>מפת גינות ובתי קפה – שאלון איכויות</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
/* --- CSS כמו שהייתה אצלך --- */
body { margin:0; padding:0; direction:rtl; font-family:sans-serif; overflow:hidden; }
#map { position:absolute; top:0; bottom:0; width:100%; }
.popup-container { /* כמו שהיה אצלך */ }
/* כל שאר ה-CSS נשאר זהה */
</style>
</head>
<body>

<div id="map"></div>
<div id="main-question">
  <strong>אילו איכויות יש למרחבים הציבוריים הירוקים בסביבת המגורים שלכם?</strong><br>
  אנא לחצו על תמונה וענו על השאלה.
</div>

<div id="nickname-popup" class="popup-container">
  <p>😊 אנא הכניסו כינוי אישי:</p>
  <input type="text" id="nickname-input" placeholder="למשל: פילפילון">
  <button id="nickname-submit">שלח</button>
</div>

<div id="popup" class="popup-container">
  <p class="question">אילו איכויות יש למרחב?</p>
  <h4 id="popup-title"></h4>
  <img id="popup-img" src="">
  <div id="checkboxes"></div>
  <div id="additional-question">
    <p><strong>האם יש למקום איכויות נוספות?</strong></p>
    <button id="yes-btn">כן</button>
    <button id="no-btn">לא</button>
  </div>
  <div id="save-msg" class="save-msg">✔ נשמר!</div>
</div>

<div id="check-icon" class="confirm-icon">✔</div>
<button id="finish-btn">סיום שאלון</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyom4ORO0eatLuYOOL8U0H89aUWAp0iWlwVqoSZ2NTrRtWgPycwGJOQwIiz3SKC-mFQ/exec";

const map = L.map("map").setView([32.125, 34.802], 16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const qualities = [
  "נוף יפה","מרחב טבע","הרגשה של יער","חופש ומרחב","פארק אטרקטיבי",
  "שקט ושלווה","אזור עם מתקנים לפעילויות","היסטוריה ותרבות","אתר טבע חשוב",
  "לא נעים","מפחיד","רועש","איכות אחרת – כתבו כאן:"
];

const parksData = [
  {"name":"גן רוזין","lat":32.126187,"lon":34.803838},
  {"name":"גן אלפרד ביר","lat":32.126725,"lon":34.799704},
  {"name":"מרכז קהילתי רוזין","lat":32.126956,"lon":34.804118},
  {"name":"מרכז אלרם-שוסטר","lat":32.125162,"lon":34.803658},
  {"name":"קאנטרי גימל","lat":32.127565,"lon":34.803042},
  {"name":"גן הפסל","lat":32.126009,"lon":34.797823},
  {"name":"גן פיינשטיין","lat":32.127806,"lon":34.798541},
  {"name":"גן מלקינד","lat":32.128201,"lon":34.796766},
  {"name":"קאנטרי ברזני","lat":32.127002,"lon":34.796730},
  {"name":"חורשת דרזנר","lat":32.128074,"lon":34.806370}
];

let nickname = "";
const nicknamePopup = document.getElementById("nickname-popup");
const nicknameInput = document.getElementById("nickname-input");
const nicknameSubmit = document.getElementById("nickname-submit");

// הצגת חלונית הכינוי מיד
nicknamePopup.classList.add("show");

nicknameSubmit.onclick = () => {
  if(nicknameInput.value.trim()==="") { alert("אנא הכניסו כינוי!"); return; }
  nickname = nicknameInput.value.trim();
  localStorage.setItem("nickname", nickname);
  fetch(SCRIPT_URL,{
    method:"POST",
    body: JSON.stringify({nickname, timestamp:new Date().toISOString()}),
    headers: {"Content-Type":"application/json"}
  });
  nicknamePopup.classList.remove("show");
  alert("תודה! עכשיו אפשר להתחיל במפה 😊");
};

const userId = localStorage.getItem("userId") || Math.random().toString(36).substr(2,9);
localStorage.setItem("userId", userId);

function sendDataToSheet(parkName, quality, value){
  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({parkName, quality, value, userId, nickname, timestamp:new Date().toISOString()}),
    headers: {"Content-Type":"application/json"}
  }).then(res => res.json()).then(d => console.log("נשלח:", d)).catch(e => console.error(e));
}

function createIcon(name, active=false){
  const borderColor = active ? "#00C853":"white";
  const background = active ? "#C8E6C9":"#4CAF50";
  return L.divIcon({
    className:"",
    html:`<div class="marker-thumb" style="border-color:${borderColor};background:${background};">
            <img src="images/${name}.jpg" onerror="this.style.display='none';this.parentElement.style.backgroundColor='#228B22';">
          </div>`
  });
}

let selectedParks = 0;
const mainQuestion = document.getElementById("main-question");
const finishBtn = document.getElementById("finish-btn");

parksData.forEach(p=>{
  p.hasSelection=false;
  const marker = L.marker([p.lat,p.lon], {icon:createIcon(p.name,false)}).addTo(map);

  marker.on("click",()=>{
    const popup=document.getElementById("popup");
    const title=document.getElementById("popup-title");
    const img=document.getElementById("popup-img");
    const checkboxesDiv=document.getElementById("checkboxes");
    const additionalQ=document.getElementById("additional-question");
    const yesBtn=document.getElementById("yes-btn");
    const noBtn=document.getElementById("no-btn");
    const saveMsg=document.getElementById("save-msg");
    const checkIcon=document.getElementById("check-icon");

    title.textContent=p.name;
    img.src=`images/${p.name}.jpg`;

    checkboxesDiv.innerHTML="";
    additionalQ.classList.remove("show");
    saveMsg.style.display="none";

    qualities.forEach(q=>{
      if(q.includes("איכות אחרת")){
        checkboxesDiv.innerHTML+=
          `<label><input type="checkbox" value="${q}" class="chk"> ${q}</label>
           <textarea class="other-text" placeholder="כתבו כאן..." rows="2"></textarea>`;
      } else {
        checkboxesDiv.innerHTML+=
          `<label><input type="checkbox" value="${q}" class="chk"> ${q}</label>`;
      }
    });

    popup.classList.add("show");

    const checkboxes = checkboxesDiv.querySelectorAll("input[type='checkbox']");
    const otherField = checkboxesDiv.querySelector(".other-text");
    let typingTimer;

    checkboxes.forEach(chk=>{
      chk.onchange=()=>{
        const anyChecked=[...checkboxes].some(c=>c.checked);

        if(!p.hasSelection && anyChecked) selectedParks++;
        p.hasSelection=anyChecked;

        marker.setIcon(createIcon(p.name, anyChecked));
        sendDataToSheet(p.name, chk.value, chk.checked);

        if(anyChecked){
          checkIcon.classList.add("show");
          setTimeout(()=>{ checkIcon.classList.remove("show"); additionalQ.classList.add("show"); },800);
        }

        if(selectedParks>=5) finishBtn.classList.add("ready");
      };
    });

    if(otherField){
      otherField.addEventListener("input", ()=>{
        clearTimeout(typingTimer);
        typingTimer = setTimeout(()=>{ sendDataToSheet(p.name,"איכות אחרת (טקסט חופשי)",otherField.value); },1200);
      });
    }

    yesBtn.onclick=()=>additionalQ.classList.remove("show");
    noBtn.onclick=()=>{
      additionalQ.classList.remove("show");
      saveMsg.style.display="block";
      setTimeout(()=>popup.classList.remove("show"),1500);
    };
  });
});

finishBtn.onclick=()=>{
  if(selectedParks>=5) alert("תודה שסיימתם את השאלון!");
};
</script>
</body>
</html>

